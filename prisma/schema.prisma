generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS - Research Study Types
// ============================================

enum TestType {
  HEXACO
  HEXACO_MODIFIED
  BIG_FIVE
  MBTI
}

enum RelationshipType {
  FRIEND
  COLLEAGUE
  FAMILY
  PARTNER
  OTHER
}

enum InvitationStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELED
}

// ============================================
// MODELS
// ============================================

model UserProfile {
  id        String   @id @default(cuid())
  clerkId   String?  @unique
  email     String?
  username  String?
  deleted   Boolean  @default(false)
  locale    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Demographic data (onboarding)
  birthYear   Int?
  gender      String?
  education   String?
  occupation  String?
  occupationStatus String?
  workSchedule String?
  companySize String?
  studyLevel String?
  unemploymentDuration String?
  country     String?
  onboardedAt DateTime?

  // Research study fields
  testType           TestType?
  testTypeAssignedAt DateTime?
  consentedAt        DateTime?

  assessmentResults    AssessmentResult[]
  assessmentDraft      AssessmentDraft?
  sentInvitations      ObserverInvitation[] @relation("InviterInvitations")
  receivedInvitations  ObserverInvitation[] @relation("ObserverInvitations")
  satisfactionFeedback SatisfactionFeedback?
}

model AssessmentDraft {
  id            String   @id @default(cuid())
  userProfileId String   @unique
  testType      TestType
  answers       Json     // Record<number, number> â€” questionId â†’ value
  currentPage   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userProfile UserProfile @relation(fields: [userProfileId], references: [id])
}

model AssessmentResult {
  id            String   @id @default(cuid())
  userProfileId String?
  scores        Json
  createdAt     DateTime @default(now())

  // Research study fields
  testType         TestType?
  isSelfAssessment Boolean   @default(true)

  userProfile       UserProfile?        @relation(fields: [userProfileId], references: [id])
  dimensionFeedback DimensionFeedback[]

  @@index([userProfileId])
}

// Observer invitation for peer assessment
model ObserverInvitation {
  id            String           @id @default(cuid())
  token         String           @unique @default(cuid())
  inviterId     String
  observerProfileId String?
  observerEmail String?
  observerName  String?
  testType      TestType
  status        InvitationStatus @default(PENDING)
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  completedAt   DateTime?

  inviter    UserProfile         @relation("InviterInvitations", fields: [inviterId], references: [id])
  observer   UserProfile?        @relation("ObserverInvitations", fields: [observerProfileId], references: [id])
  assessment ObserverAssessment?

  @@index([inviterId])
  @@index([observerProfileId])
  @@index([token])
}

// Observer's assessment of the inviter
model ObserverAssessment {
  id               String           @id @default(cuid())
  invitationId     String           @unique
  relationshipType RelationshipType
  knownDuration    String // "LT_1", "1_3", "3_5", "5P"
  scores           Json
  confidence       Int? // 1-5: observer's self-rated certainty (research quality filter)
  createdAt        DateTime         @default(now())

  invitation ObserverInvitation @relation(fields: [invitationId], references: [id])
}

// Satisfaction feedback for research comparison
model SatisfactionFeedback {
  id                         String   @id @default(cuid())
  userProfileId              String   @unique
  agreementScore             Int // 1-5 (ğŸ˜•ğŸ˜ğŸ™‚ğŸ˜ŠğŸ¤©) - "Mennyire ismertÃ©l magadra?"
  observerFeedbackUsefulness Int? // 1-5 (ğŸ˜•ğŸ˜ğŸ™‚ğŸ˜ŠğŸ¤©) - Optional: usefulness of observer feedback
  siteUsefulness             Int? // 1-5 (ğŸ˜•ğŸ˜ğŸ™‚ğŸ˜ŠğŸ¤©) - Optional: overall site usefulness
  freeformFeedback           String?
  interestedInUpdates        Boolean @default(false)
  createdAt                  DateTime @default(now())

  userProfile UserProfile @relation(fields: [userProfileId], references: [id])
}

// Dimension-level feedback for accuracy assessment
model DimensionFeedback {
  id                String   @id @default(cuid())
  assessmentResultId String
  dimensionCode     String   // "H", "E", "X", "A", "C", "O" (HEXACO) or "O", "C", "E", "A", "N" (BIG_FIVE)
  accuracyRating    Int      // 1-5 (ğŸ˜•ğŸ˜ğŸ™‚ğŸ˜ŠğŸ¤©)
  comment           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  assessmentResult AssessmentResult @relation(fields: [assessmentResultId], references: [id], onDelete: Cascade)

  @@unique([assessmentResultId, dimensionCode])
  @@index([assessmentResultId])
}
